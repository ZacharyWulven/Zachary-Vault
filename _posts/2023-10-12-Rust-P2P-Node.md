---
layout: post
title: 使用 Async Rust 构建 P2P 节点
date: 2023-10-12 16:45:30.000000000 +09:00
categories: [Rust, Rust Async]
tags: [Rust, Rust Async]
---


# `P2P` 简介

## `P2P` 定义
* `P2P`：即 peer-to-peer
* `P2P` 是一种网络技术，可以在不同的计算机之间共享各种计算机资源，如 CPU、网络带宽和存储
* `P2P` 是当今用户在线常用的共享文件（如音乐、图像、和其他数字媒体）的一种方法
  * `Bittorrent 和 Gnutella` 是比较流行的文件共享 P2P 应用程序，
  * 比特币和以太坊等区块链网络也是 `P2P` 的
  * 它们不依赖中央服务器或中介来连接多个客户端
  * 最重要的是，它们利用用户的计算机作为客户端和服务器，从而将计算从中央服务器上卸载下来


* 传统的分布式系统使用 `Client-Server` 范式来部署的
* 而 `P2P` 是另外一种分布式系统
  * 在 `P2P` 中，一组节点（或叫对等点，Peer）彼此直接交互以共同提供公共服务，这样就无需中央协调器或管理员
  * `P2P` 系统中的每个节点（或叫 Peer）都可以充当客户端（从其他节点请求信息）或服务器（存储、检索数据并响应客户端请求执行必要的计算）
  * `P2P` 网络中的所有节点不必完全相同，有一个关键特征将 `Client-Server` 网络与 `P2P` 网络区分开来
    * 即在 `P2P` 网络中，缺乏具有唯一权限的专用服务器。
    * 在开放、无许可的 `P2P` 网络中，任何节点都可以决定提供与 `P2P` 节点相关的全部或部分服务集
  
## `P2P` 特点
* 与 `Client-Server` 网络相比，`P2P` 网络能够在其上构建不同类别的应用程序，这些程序是无许可、容错和抗审查的。
  * 无许可：因为数据和状态是跨多个节点复制的，所以没有服务器可以切断客户机对信息的访问
  * 容错性：因为没有单点故障，例如中央服务器
  * 抗审查：如区块链等网络
  * P2P 计算还可以更好的利用资源
  

![image](/assets/images/rust/peer.png)

## `P2P` 的复杂性
* `P2P` 系统的复杂性比 `Client-Server` 的系统要高
  * 传输：`P2P` 网络中的每个 `Peer` 都可以使用不同的协议，例如 `HTTP(s)、TCP、UDP` 等
  * 身份：每个 `Peer` 都需要知道其想要连接并发送消息的 `Peer` 的身份
  * 安全性：每个 `Peer` 都应该能够以安全的方式与其他 `Peer` 通信，而不存在第三方拦截或修改消息的风险等
  * 路由：每个 `Peer` 可以通过各种路由（例如数据包在 IP 协议中的分别方式）从其他 `Peer` 接收消息，这意味着如果消息不是针对自身的，则每个 `Peer` 都应该能够将消息路由到其他 `Peer`
  * 消息传递：`P2P` 网络应该能够发送点对点消息或组消息（组消息以发布/订阅模式发布的）
  
  
## `P2P` 的要求

### 对传输的要求
* `TCP/IP` 和 `UDP` 协议无处不在，在编写网络应用程序时非常流行。但还有其他更高级别的协议，例如 HTTP（TCP 上分层）和 QUIC（UDP 上分层）
* `P2P` 网络中的每个 `Peer` 都应该能够启动到另一个节点的连接，并且由于网络中 `Peer` 的多样性，能够通过多个协议监听传入的连接。

### `Peer` 身份的要求  
* 与 `web` 开发领域不同，在 `web` 开发领域中，服务器由唯一的域名标识（例如 www.rust-lang.org），然后使用域名服务将其解析为服务器的 IP 地址
* `P2P` 网络中的节点需要唯一身份，以便其他节点可以访问它们
* `P2P` 网络中的节点使用公钥和私钥对（非对称加密），与其他节点建立安全通信
  * `P2P` 网络中节点的身份称为 `PeerId`，是`节点公钥的加密散列`

### 对安全的要求
* 加密密钥对和 `PeerId` 使节点能够与它的 `Peers` 建立安全、经过身份验证的通信通道。但这只是安全的一个方面。
* 节点还需要实现授权框架，这个框架为哪个节点可以执行何种操作建立规则
* 还需要解决网络级的安全威胁：
  * 例如 `Sybil Attack`：即其他一个节点运营商利用不同身份启用大量节点，以获得网络中的优势地位
  * 或 `Eclipse Attack`：即其中一组恶意节点共谋以特定节点为目标，使后者无法到达任何合法节点

### 对路由的要求
* `P2P` 网络中的节点首先需要找到其他 `Peer` 才能进行通信。这是通过维护 `Peer` 路由表来实现的，这个表中包含对网络中其他 `Peer` 的引用
* 但是，在具有数千个或更多动态变化的节点（即节点加入和离开网络）的 P2P 网络中，任何单个节点都难以为网络中的所有节点维护完整而准确的路由表。
* 而 `Peer` 路由可以使节点能够将不是给自己准备的消息路由到目标节点

### 对消息的要求
* `P2P` 网络中的节点可以向特定节点发送消息，但也可以参与广播消息协议
  * 例如，发布/订阅模式，其中节点注册对特定主题的兴趣（订阅），而发送该主题消息的任何节点（发布）都由订阅该主题的所有节点接收
  * 这种技术通常用于将消息的内容传输到整个网络

### 对流多路复用的要求
* 流多路复用（Stream multiplexing）：即通过公共通信链路发送多个信息流的一种方法
* 在 `P2P` 情况下，它允许多个独立的 `逻辑流` 共享一个公共 `P2P` 传输层
  * 当考虑到一个节点与不同的 `Peers` 具有多个通信流的可能性，或者连个远程节点之间也可能存在多个并发连接的可能性时，这一点变的很重要
  * 流多路复用有助于优化 `Peer` 之间建立连接的开销


> 流多路复用在后端服务开发中很常见，其中客户端可以与服务器建立底层网络连接，然后通过底层网络连接多路复用不同的流（每个流有唯一的端口号）
{: .prompt-info }


# 构建

* 需要使用 `libp2p` 库，当然也可以不使用库，但是使用这个库会简单一些

## `libp2p` 库
* `libp2p` 是一个由协议、规范和库组成的模块化系统，它支持 `P2P` 应用程序开发
* 它目前支持三种语言：`JS、Go、Rust`
  * 未来将支持 `Hashell、Java、Python` 等
* 它被许多流行的项目使用，例如 `IPFS、Filecoin、Polkadot` 等

## `libp2p` 库的主要模块
* 传输模块（Transport）：负责一个 `Peer` 到另一个 `Peer` 的数据的实际传输和接收
* 身份模块（Identity）：`libp2p` 使用公钥密码（PKI）作为 `Peer` 节点身份的基础。使用加密算法为每个节点生产唯一的 `Peer id`
* 安全模块（Security）：节点使用其私钥对消息进行签名。节点之间的传输连接可以升级为安全的加密通道，以便远程 `Peer` 可以相互信任，并且没有第三方可以拦截它们之间的通信
* Peer 发现（Peer Discovery）：允许 `Peer` 在 `libp2p` 网络中查找并相互通信
* Peer 路由（Peer Routing）：使用其他 `Peer` 的知识信息来实现与 `Peer` 节点的通信
* 内容发现（Content Discovery）：在不知地哪些 `Peer` 节点拥有该内容的情况下，允许 `Peer` 节点从其他 `Peer` 节点获取部分内容
* 消息（Messaging）：允许向指定节点发送消息，也可以使用 `发布/订阅模式` 向一组 `Peer` 发送消息


## `P2P` 节点的身份

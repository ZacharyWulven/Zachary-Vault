---
layout: post
title: ETH-04-权益证明
date: 2022-08-09 16:45:30.000000000 +09:00
tag: 区块链
---

## 0x01 能耗

![](/assets/images/eth/btc_cost.png)

![](/assets/images/eth/eth_cost.png)

![](/assets/images/eth/cost.png)


## 0x02 权益思想 PoS
基本实现：矿工其实是通过竞争算力来决定挖矿的收益如何分配，谁买的设备好、多谁的算力就强，那直接把钱投入区块链的开发，最后根据每个人投钱的比例分配收益就好
这种思想也叫 virtual mining 虚拟挖矿

* 类似于股份制公司，按各自股份也就是各自质押的货币
* 使用权益证明发币前一般会留一部分币给开发者，也会出售一部分货币来换取开发这个货币所需要的资金
* 将来按照权益证明机制，按照每个人持有货币的数量投票

### 权益证明的优点
* 省去了挖矿的过程
* 减少能耗，减少温室气体的排放，对环境生态有好处


### 权益证明是一个闭环
基于工作量证明的共识系统，在某种意义上说维护这个区块链的安全的资源不是一个闭环
* 即发动攻击是可以从外面世界得到的
* 比如一个组织在金融或石油等很有钱，就可以把这些资源转化为算力用于攻击，比较加密货币市值跟股市差的很多 

AltCoin Infanticide 把小币种扼杀在摇篮里

### 权益证明和工作量证明可以混合使用
* 比如挖矿难度根据你质押的大小而调整
* 但如果简单的根据质押货币量来减少挖矿难度是不公平的，因为钱多的永远挖矿容易
* 一个做法是挖当前区块，质押进来的币当次使用，一旦有新区块了，那么之前质押的币会被锁定一定时间，比如几个区块后才能继续使用用于减少自己的挖矿难度。
这个叫 Proof of Deposit

基于权益证明的设计有很多挑战。早期基于权益证明遇到的问题即两边下注的问题也叫 nothing at stake。比如现在分叉了两个链，你会继续沿着那个挖，如果是 PoW 只能选一个，
但基于权益证明可以两边都压。
因为如果一个链胜出了，另一个链你投入的币不会受影响，因为只记录在这条链上


## 0x03 Casper
以太坊中准备用的权益证明协议叫 Casper
* Casper the Friendly Finality Gadget （FFG）
* 在过度阶段与工作量证明混合使用，为工作量证明提供 Finality
* Finality 是一个最终的状态，包含在 Finality 中的交易不会被取消
* 单纯基于工作量证明的交易时有可能被回滚的，是缺少 Finality 的，像比特币要等 6 个确认区块。

### Casper 原理
* 如何实现：引入了一个概念叫验证者 Validator
* 若想成为 Validator 就要质押一定数量的以太币作为保证金，保证金会被系统锁定住
* Validator 的职责是要推导系统达成共识，投票哪条链是最长合法链，投票的权重由保证金的数量决定
* 做法有点像数据库的 two-phase commit，混用的时候还是有人挖矿。
挖矿时每挖出 100 个区块，就作为一个 epoch，然后决定它能不能成为 Finality，进行投票，第一轮投票时 Prepare message，第二轮投票时 Commit message
* Casper 规定每轮投票都需要 2/3（按保证金大小算）以上的 Validator 才能通过
* 实际优化后的系统中不再区分 Prepare message 和 Commit message，而且 epoch 减小为每 50 个区块是一个 epoch
* 然后每个 epoch 只用一轮投票就行了，当前这轮投票对于上一个 epoch 来说是 Commit message，对下一个 epoch 是 Prepare message
* 然后连续两个投票即 2/3 Validator 都同意才算有效

Casper 最初版本
![](/assets/images/eth/epoch1.png)

Casper 实际使用的优化后的版本

![](/assets/images/eth/epoch2.png)


* 那么 Validator 参与这个过程有什么好处呢？
1. 如果 Validator 履行职责的话能获得相应的奖励，就像矿工挖矿能得到奖励一样
2. 如果 Validator 有不良行为被发现的话会受到相应处罚，比如该投票而不投票导致系统迟迟达不成共识，就会扣一部分保证金
3. 如果 Validator 乱投票，要没收全部的保证金，没收的保证金会被直接销毁，相当于减少了系统中以太币的总供应量
* 每个 Validator 有一定的任期，任期满后要经过一定时间的等待期，等待期是让其他节点检举、揭发这个 Validator 有没有不良行为，
如果等待期过了没有什么问题，那么 Validator 可以取回保证金和作为 Validator 的奖励


### 问题：Casper 的 Finality 有没有可能被推翻？
* 如果发动攻击的只是矿工的话，它是不能推翻已经达成共识的 Finality，因为共识是 Validator 投票投出来的
* 单纯有恶意的矿工不论它算力有多强，如果没有 Validator 同伙是不可能推翻 Finality 的

那什么情况能够推翻 Finality ？ 
* 如果有至少 1/3 的 Validator 两边都投票，即给两个有冲突的 Finality 都下注投票，则攻击成功
* 但如果被发现的话这 1/3 Validator 的保证金将被全部被没收销毁

以太坊没有一开始就用权益证明是因为权益证明还不太成熟，因为 PoW 是经过了时间的检验


### EOS（柚子）
* EOS 就是基于权益证明的但用的是 DPOS（Delegated Proof of Stake）协议
* 现在用投票方式选出 21 个超级节点，然后再通过超级节点选择出块


### 讨论
* 很多人 PoW 有反感是因为他们认为做的是无用功，白白浪费了电。其实比特币和以太坊加起来能耗占全世界 0.4% 对环境的影响是有限的
* 挖矿的好处是提供了一种把电能转换为钱的一种手段
* 有些国家主电网是单向的，即只能从主电网给边远区域送电
* 而挖矿把多余电能转换为加密货币，很多矿厂都是建设在电力资源丰富的地方，只有有电有网就能挖矿，传输都不是问题，只要保存好私钥，
所以有的人认为挖矿不是坏事，可以有效的化解过剩产能，提升当地经济的发展



{% highlight ruby %}
以太坊的最长合法链也可以叫最长难度最大的链
{% endhighlight %}
